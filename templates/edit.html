<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Habit</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    .chip { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .5rem; border-radius:9999px; background:#e9eef7; margin:.25rem .25rem 0 0; }
    .chip button { border:none; background:transparent; cursor:pointer; font-size:1rem; line-height:1; }
    .row { display:flex; gap:.5rem; align-items:center; margin:.5rem 0; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <a href="{{ url_for('index') }}">← Back</a>
  <h1>Edit Habit</h1>

  <form method="POST" action="{{ url_for('edit', habit_id=habit.id) }}">
    <label>Name</label>
    <input name="new_name" value="{{ habit.name }}" required />

    <label>Created (YYYY-MM-DD)</label>
    <input name="new_created" value="{{ habit.created }}" required />

    <label>Streak</label>
    <input name="new_streak" type="number" min="0" value="{{ habit.streak }}" required />

    <label>History</label>
    <div class="row">
      <input id="date-input" type="date" />
      <button type="button" onclick="addFromPicker()">Add date</button>
      <button type="button" onclick="addToday()">Today</button>
      <button type="button" onclick="addYesterday()">Yesterday</button>
    </div>
    <div id="chips"></div>
    <div class="muted">Dates are saved as YYYY-MM-DD. Click × to remove.</div>

    <!-- The textarea remains the single source of truth posted to Flask -->
    <textarea id="history-box" name="new_history" rows="6" style="width:100%">{{ '\n'.join(habit.history) }}</textarea>

    <button type="submit">Save</button>
  </form>

  <script>
    function parseHistory() {
      const raw = document.getElementById('history-box').value.trim().replace(/\r/g,'');
      if (!raw) return [];
      // accept commas or newlines
      const parts = raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      return Array.from(new Set(parts)).sort(); // unique + sorted
    }
    function syncTextarea(dates) {
      document.getElementById('history-box').value = dates.join('\n');
      renderChips(dates);
    }
    function renderChips(dates = parseHistory()) {
      const box = document.getElementById('chips');
      box.innerHTML = '';
      dates.forEach(d => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = d;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = '×';
        btn.onclick = () => {
          const next = parseHistory().filter(x => x !== d);
          syncTextarea(next);
        };
        chip.appendChild(btn);
        box.appendChild(chip);
      });
    }
    function addDateStr(s) {
      if (!s) return;
      const dates = parseHistory();
      if (!dates.includes(s)) {
        dates.push(s);
        dates.sort();
        syncTextarea(dates);
      }
    }
    function addFromPicker() {
      const v = document.getElementById('date-input').value; // YYYY-MM-DD
      addDateStr(v);
      document.getElementById('date-input').value = '';
    }
    function addToday() {
      const t = new Date().toISOString().slice(0,10);
      addDateStr(t);
    }
    function addYesterday() {
      const d = new Date(); d.setDate(d.getDate()-1);
      addDateStr(d.toISOString().slice(0,10));
    }
    // initialize chips from existing history
    window.addEventListener('DOMContentLoaded', () => renderChips());
  </script>
</body>
</html>
